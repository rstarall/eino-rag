{{define "chat.html"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    
    <!-- Markdownæ¸²æŸ“åº“ -->
    <script src="https://unpkg.com/markdown-it@13.0.2/dist/markdown-it.min.js"></script>
    <!-- ä»£ç è¯­æ³•é«˜äº® -->
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github.min.css">
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
    <!-- æ•°å­¦å…¬å¼æ”¯æŒ -->
    <link rel="stylesheet" href="https://unpkg.com/katex@0.16.9/dist/katex.min.css">
    <script src="https://unpkg.com/katex@0.16.9/dist/katex.min.js"></script>
    
    <style>
        /* Markdownæ¸²æŸ“æ ·å¼ä¼˜åŒ– */
        .message-text {
            line-height: 1.6;
        }
        
        .message-text h1, .message-text h2, .message-text h3, 
        .message-text h4, .message-text h5, .message-text h6 {
            margin: 1em 0 0.5em 0;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .message-text h1 { font-size: 1.5em; color: var(--primary-color, #007bff); }
        .message-text h2 { font-size: 1.3em; color: var(--primary-color, #007bff); }
        .message-text h3 { font-size: 1.2em; }
        .message-text h4 { font-size: 1.1em; }
        
        .message-text p {
            margin: 0.8em 0;
        }
        
        .message-text ul, .message-text ol {
            margin: 0.8em 0;
            padding-left: 2em;
        }
        
        .message-text li {
            margin: 0.3em 0;
        }
        
        .message-text blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            background: var(--background-secondary, #f8f9fa);
            border-left: 4px solid var(--primary-color, #007bff);
            border-radius: 0 4px 4px 0;
        }
        
        .message-text code {
            background: var(--background-secondary, #f8f9fa);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        
        .message-text pre {
            background: var(--background-secondary, #f8f9fa);
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
            border: 1px solid var(--border-color, #e1e4e8);
        }
        
        .message-text pre code {
            background: none;
            padding: 0;
            font-size: 0.9em;
        }
        
        .message-text table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            border: 1px solid var(--border-color, #e1e4e8);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .message-text th, .message-text td {
            padding: 0.75em 1em;
            text-align: left;
            border-bottom: 1px solid var(--border-color, #e1e4e8);
        }
        
        .message-text th {
            background: var(--background-secondary, #f8f9fa);
            font-weight: 600;
        }
        
        .message-text tr:hover {
            background: var(--background-secondary, #f8f9fa);
        }
        
        .message-text a {
            color: var(--primary-color, #007bff);
            text-decoration: none;
        }
        
        .message-text a:hover {
            text-decoration: underline;
        }
        
        /* æ•°å­¦å…¬å¼æ ·å¼ */
        .message-text .katex {
            font-size: 1em;
        }
        
        .message-text .math-block {
            margin: 1em 0;
            text-align: center;
            overflow-x: auto;
        }
        
        /* èŠå¤©è¾“å…¥åŒºåŸŸä¼˜åŒ– */
        .chat-input-container {
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color, #e1e4e8) !important;
            padding: 1.5rem !important;
            z-index: 100;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        .chat-input-form {
            margin-bottom: 0.75rem;
        }
        
        .input-wrapper {
            position: relative;
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--border-color, #e1e4e8);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            padding: 16px 60px 16px 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .input-wrapper:focus-within {
            border-color: var(--primary-color, #007bff);
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.15);
        }
        
        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 1rem;
            line-height: 1.4;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            font-family: inherit;
            color: var(--text-primary, #333);
        }
        
        .chat-input::placeholder {
            color: var(--text-secondary, #999);
        }
        
        .send-button {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: var(--primary-color, #007bff);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .send-button:hover:not(:disabled) {
            background: var(--primary-dark, #0056b3);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }
        
        .send-button:disabled {
            background: var(--text-secondary, #999);
            cursor: not-allowed;
            box-shadow: none;
            transform: translateY(-50%);
            opacity: 0.6;
        }
        
        .send-button:active:not(:disabled) {
            transform: translateY(-50%) scale(0.95);
        }
        
        .input-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 4px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary, #666);
            user-select: none;
        }
        
        .option-item input[type="checkbox"] {
            display: none;
        }
        
        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color, #ddd);
            border-radius: 4px;
            margin-right: 8px;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .option-item input[type="checkbox"]:checked + .checkmark {
            background: var(--primary-color, #007bff);
            border-color: var(--primary-color, #007bff);
        }
        
        .option-item input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .option-item:hover .checkmark {
            border-color: var(--primary-color, #007bff);
        }
        
        .option-text {
            transition: color 0.2s ease;
        }
        
        .option-item:hover .option-text {
            color: var(--primary-color, #007bff);
        }
        
        .input-stats {
            font-size: 0.8rem;
            color: var(--text-secondary, #999);
            font-family: monospace;
        }
        
        /* è¾“å…¥æ¡†åŠ è½½çŠ¶æ€ */
        .input-wrapper.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .input-wrapper.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 60px;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color, #ddd);
            border-top-color: var(--primary-color, #007bff);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: translateY(-50%) rotate(0deg);
            }
            100% {
                transform: translateY(-50%) rotate(360deg);
            }
        }
        
        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸè°ƒæ•´ */
        .chat-main {
            position: relative !important;
        }
        
        .chat-messages {
            padding-bottom: 140px; /* ä¸ºå›ºå®šè¾“å…¥æ¡†ç•™å‡ºç©ºé—´ */
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        
        /* ä¸­ç­‰å±å¹• - å¹³æ¿ */
        @media (max-width: 1024px) {
            .input-wrapper {
                padding: 12px 55px 12px 18px;
            }
        }
        
        /* å°å±å¹• - æ‰‹æœº */
        @media (max-width: 768px) {
            .message-text table {
                font-size: 0.9em;
            }
            
            .message-text th, .message-text td {
                padding: 0.5em 0.75em;
            }
            
            .chat-input-container {
                padding: 1rem !important;
            }
            
            .chat-messages {
                padding-bottom: 120px;
            }
            
            .input-wrapper {
                padding: 10px 50px 10px 16px;
            }
            
            .send-button {
                width: 32px;
                height: 32px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="alert-container" style="position: fixed; top: 1rem; right: 1rem; z-index: 9999;"></div>
<nav class="navbar">
    <div class="container">
        <div class="navbar-content">
            <a href="/" class="navbar-brand">Eino RAG</a>
            <div class="navbar-menu">
                <select id="kbSelect" class="form-control" style="width: 200px;">
                    <option value="">é€‰æ‹©çŸ¥è¯†åº“ï¼ˆå¯é€‰ï¼‰</option>
                </select>
                <span class="user-name"></span>
                <a href="/admin" class="btn btn-outline">ç®¡ç†åå°</a>
                <button class="btn btn-secondary logout-btn">é€€å‡º</button>
            </div>
        </div>
    </div>
</nav>

<div class="chat-container">
    <div class="chat-sidebar">
        <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="startNewChat()">
            æ–°å»ºå¯¹è¯
        </button>
        
        <h3 style="margin-bottom: 1rem;">å†å²å¯¹è¯</h3>
        <div id="conversationList"></div>
    </div>
    
    <div class="chat-main">
        <div class="chat-header">
            <h2 id="chatTitle">æ™ºèƒ½å¯¹è¯åŠ©æ‰‹</h2>
        </div>
        
        <div class="chat-messages" id="messageContainer">
            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                <p>æ¬¢è¿ä½¿ç”¨ Eino RAG æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ</p>
                <p>æ‚¨å¯ä»¥ç›´æ¥å¼€å§‹å¯¹è¯ï¼Œæˆ–é€‰æ‹©çŸ¥è¯†åº“è·å¾—æ›´ç²¾å‡†çš„å›ç­”</p>
            </div>
        </div>
        
        <div class="chat-input-container">
            <form class="chat-input-form" id="chatForm">
                <div class="input-wrapper">
                    <textarea class="chat-input" id="messageInput" 
                              placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                              rows="1"
                              disabled></textarea>
                    <button type="submit" class="send-button" id="sendBtn" disabled>
                        <svg viewBox="0 0 24 24" width="20" height="20">
                            <path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                        </svg>
                    </button>
                </div>
            </form>
            <div class="input-options">
                <label class="option-item">
                    <input type="checkbox" id="showContext" checked>
                    <span class="checkmark"></span>
                    <span class="option-text">æ˜¾ç¤ºæ£€ç´¢ä¸Šä¸‹æ–‡</span>
                </label>
                <div class="input-stats">
                    <span id="charCount">0</span> / 2000
                </div>
            </div>
        </div>
    </div>
</div>
    
    <script src="/static/js/api.js"></script>
    <script src="/static/js/app.js"></script>
<script>
let currentConversationId = null;
let currentKbId = null;

// åˆå§‹åŒ–Markdownæ¸²æŸ“å™¨
let markdownRenderer;

// ç­‰å¾…æ‰€æœ‰åº“åŠ è½½å®Œæˆ
function initializeMarkdown() {
    try {
        // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦å·²åŠ è½½
        if (typeof window.markdownit === 'undefined') {
            console.error('markdown-it æœªåŠ è½½');
            return false;
        }
        
        // é…ç½®markdown-it
        markdownRenderer = window.markdownit({
            html: false,        // ç¦ç”¨HTMLæ ‡ç­¾ä»¥ç¡®ä¿å®‰å…¨
            xhtmlOut: false,    // ä½¿ç”¨HTML5æ ‡ç­¾
            breaks: true,       // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
            linkify: true,      // è‡ªåŠ¨è¯†åˆ«é“¾æ¥
            typographer: true,  // å¯ç”¨æ™ºèƒ½å¼•å·å’Œå…¶ä»–æ’ç‰ˆæ›¿æ¢
            highlight: function (str, lang) {
                // æ£€æŸ¥hljsæ˜¯å¦å¯ç”¨
                if (typeof window.hljs !== 'undefined' && lang && window.hljs.getLanguage(lang)) {
                    try {
                        return '<pre class="hljs"><code>' +
                               window.hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                               '</code></pre>';
                    } catch (e) {
                        console.warn('ä»£ç é«˜äº®å¤±è´¥:', e);
                    }
                }
                return '<pre class="hljs"><code>' + markdownRenderer.utils.escapeHtml(str) + '</code></pre>';
            }
        });
        
        // KaTeXæ•°å­¦å…¬å¼æ”¯æŒå°†é€šè¿‡åå¤„ç†å®ç°
        
        console.log('Markdownæ¸²æŸ“å™¨åˆå§‹åŒ–æˆåŠŸ');
        return true;
    } catch (error) {
        console.error('Markdownæ¸²æŸ“å™¨åˆå§‹åŒ–å¤±è´¥:', error);
        return false;
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿æ‰€æœ‰CDNèµ„æºéƒ½åŠ è½½å®Œæˆ
    setTimeout(() => {
        // åˆå§‹åŒ–highlight.jsï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (typeof window.hljs !== 'undefined') {
            try {
                window.hljs.highlightAll();
                console.log('highlight.jsåˆå§‹åŒ–æˆåŠŸ');
            } catch (e) {
                console.warn('highlight.jsåˆå§‹åŒ–å¤±è´¥:', e);
            }
        }
        
        // åˆå§‹åŒ–Markdownæ¸²æŸ“å™¨
        initializeMarkdown();
        
        // é¡µé¢åŠŸèƒ½åˆå§‹åŒ–
        loadKnowledgeBases();
        loadConversations();
    }, 100);
});

// Markdownæ¸²æŸ“å‡½æ•°
function renderMarkdown(text) {
    if (!markdownRenderer) {
        return text; // å¦‚æœæ¸²æŸ“å™¨æœªåˆå§‹åŒ–ï¼Œè¿”å›åŸæ–‡æœ¬
    }
    try {
        return markdownRenderer.render(text);
    } catch (error) {
        console.error('Markdownæ¸²æŸ“é”™è¯¯:', error);
        return text; // æ¸²æŸ“å¤±è´¥æ—¶è¿”å›åŸæ–‡æœ¬
    }
}

// å¤„ç†æ•°å­¦å…¬å¼
function processMathFormulas(element) {
    if (typeof window.katex !== 'undefined') {
        try {
            // å¤„ç†è¡Œå†…æ•°å­¦å…¬å¼ $...$
            element.innerHTML = element.innerHTML.replace(/\$([^$]+)\$/g, function(match, formula) {
                try {
                    return window.katex.renderToString(formula, {throwOnError: false});
                } catch (e) {
                    return match; // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œä¿æŒåŸæ–‡
                }
            });
            
            // å¤„ç†å—çº§æ•°å­¦å…¬å¼ $$...$$
            element.innerHTML = element.innerHTML.replace(/\$\$([^$]+)\$\$/g, function(match, formula) {
                try {
                    return '<div class="math-block">' + window.katex.renderToString(formula, {
                        throwOnError: false,
                        displayMode: true
                    }) + '</div>';
                } catch (e) {
                    return match; // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œä¿æŒåŸæ–‡
                }
            });
        } catch (e) {
            console.warn('æ•°å­¦å…¬å¼å¤„ç†å¤±è´¥:', e);
        }
    }
}

// å®‰å…¨çš„HTMLæ’å…¥å‡½æ•°
function setMarkdownContent(element, text) {
    const renderedHTML = renderMarkdown(text);
    element.innerHTML = renderedHTML;
    
    // å¤„ç†æ•°å­¦å…¬å¼
    processMathFormulas(element);
    
    // é‡æ–°åº”ç”¨ä»£ç é«˜äº®ï¼ˆå¦‚æœhljså¯ç”¨ï¼‰
    if (typeof window.hljs !== 'undefined') {
        try {
            element.querySelectorAll('pre code').forEach((block) => {
                window.hljs.highlightElement(block);
            });
        } catch (e) {
            console.warn('ä»£ç é«˜äº®åº”ç”¨å¤±è´¥:', e);
        }
    }
}

// åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
async function loadKnowledgeBases() {
    try {
        const result = await api.knowledgeBase.list(1, 100);
        if (result.success) {
            const select = document.getElementById('kbSelect');
            select.innerHTML = '<option value="">é€‰æ‹©çŸ¥è¯†åº“</option>';
            
            result.knowledge_bases.forEach(kb => {
                const option = document.createElement('option');
                option.value = kb.id;
                option.textContent = kb.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥:', error);
    }
}

// åŠ è½½å¯¹è¯å†å²
async function loadConversations() {
    try {
        const result = await api.chat.listConversations();
        if (result.success) {
            const list = document.getElementById('conversationList');
            list.innerHTML = '';
            
            if (result.conversations.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">æš‚æ— å¯¹è¯è®°å½•</div>';
                return;
            }
            
            result.conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                if (conv.conversation_id === currentConversationId) {
                    item.classList.add('active');
                }
                item.innerHTML = `
                    <div>${conv.title || 'æœªå‘½åå¯¹è¯'}</div>
                    <small>${new Date(conv.created_at).toLocaleString()}</small>
                `;
                item.onclick = function() { loadConversation(conv.conversation_id, this); };
                list.appendChild(item);
            });
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', error);
    }
}

// åŠ è½½å¯¹è¯å†…å®¹
async function loadConversation(id, element) {
    try {
        const result = await api.chat.getConversation(id);
        if (result.success) {
            currentConversationId = id;
            displayMessages(result.messages || []);
            
            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯å†…å®¹å¤±è´¥:', error);
        utils.showMessage('åŠ è½½å¯¹è¯å¤±è´¥', 'error');
    }
}

// å¼€å§‹æ–°å¯¹è¯
function startNewChat() {
    currentConversationId = null;
    document.getElementById('messageContainer').innerHTML = `
        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
            <p>å¼€å§‹æ–°çš„å¯¹è¯</p>
        </div>
    `;
    document.getElementById('chatTitle').textContent = 'æ–°å¯¹è¯';
}

// æ˜¾ç¤ºæ¶ˆæ¯
function displayMessages(messages) {
    const container = document.getElementById('messageContainer');
    container.innerHTML = '';
    
    messages.forEach(msg => {
        addMessage(msg.content, msg.role);
    });
    
    container.scrollTop = container.scrollHeight;
}

// æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
function addMessage(content, role) {
    const container = document.getElementById('messageContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (role === 'assistant') {
        // AIæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“
        const textDiv = document.createElement('div');
        textDiv.className = 'message-text';
        setMarkdownContent(textDiv, content);
        
        const contextDiv = document.createElement('div');
        contextDiv.className = 'message-context';
        
        contentDiv.appendChild(textDiv);
        contentDiv.appendChild(contextDiv);
    } else {
        // ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
        contentDiv.textContent = content;
    }
    
    messageDiv.appendChild(contentDiv);
    container.appendChild(messageDiv);
}

// å‘é€æ¶ˆæ¯
document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message) return;
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage(message, 'user');
    input.value = '';
    
    // é‡ç½®è¾“å…¥æ¡†é«˜åº¦å’Œå­—ç¬¦è®¡æ•°
    input.style.height = 'auto';
    document.getElementById('charCount').textContent = '0';
    document.getElementById('charCount').style.color = 'var(--text-secondary, #999)';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const inputWrapper = document.querySelector('.input-wrapper');
    inputWrapper.classList.add('loading');
    
    // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨
    const container = document.getElementById('messageContainer');
    const assistantDiv = document.createElement('div');
    assistantDiv.className = 'chat-message assistant';
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    // åˆ›å»ºæ–‡æœ¬å†…å®¹åŒºåŸŸå’Œæ–‡æ¡£ä¸Šä¸‹æ–‡åŒºåŸŸ
    const textDiv = document.createElement('div');
    textDiv.className = 'message-text';
    textDiv.textContent = 'æ­£åœ¨æ€è€ƒ...';
    
    const contextDiv = document.createElement('div');
    contextDiv.className = 'message-context';
    
    contentDiv.appendChild(textDiv);
    contentDiv.appendChild(contextDiv);
    assistantDiv.appendChild(contentDiv);
    container.appendChild(assistantDiv);
    container.scrollTop = container.scrollHeight;
    
    let isFirstChunk = true;
    let accumulatedContent = '';


    try {
        await api.chat.sendStream(
            message, 
            currentConversationId, 
            currentKbId, 
            !!currentKbId, // åªæœ‰é€‰æ‹©äº†çŸ¥è¯†åº“æ‰å¯ç”¨RAG
            // onMessage: å¤„ç†æµå¼å†…å®¹
            (content) => {
                if (isFirstChunk) {
                    textDiv.textContent = ''; // æ¸…ç©º"æ­£åœ¨æ€è€ƒ..."
                    isFirstChunk = false;
                }
                accumulatedContent += content;
                
                // å®æ—¶æ¸²æŸ“Markdownå†…å®¹
                setMarkdownContent(textDiv, accumulatedContent);
                container.scrollTop = container.scrollHeight;
            },
            // onError: å¤„ç†é”™è¯¯
            (error) => {
                console.error('æµå¼èŠå¤©å¤±è´¥:', error);
                const errorMsg = 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯: ' + (error.message || 'ç½‘ç»œé”™è¯¯');
                setMarkdownContent(textDiv, errorMsg);
                textDiv.style.color = 'var(--error-color)';
                utils.showMessage('å‘é€å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'), 'error');
                
                // ç§»é™¤åŠ è½½çŠ¶æ€
                inputWrapper.classList.remove('loading');
            },
            // onComplete: å¤„ç†å®Œæˆ
            (result) => {
                // æ›´æ–°å¯¹è¯ID
                const convId = result.conversation_id;
                if (!currentConversationId && convId) {
                    currentConversationId = convId;
                    // æ›´æ–°æ ‡é¢˜
                    document.getElementById('chatTitle').textContent = 'å¯¹è¯ ' + convId.substring(0, 8);
                    // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨
                    loadConversations();
                }
                
                // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤æ¶ˆæ¯
                if (accumulatedContent.trim() === '' || textDiv.textContent === 'æ­£åœ¨æ€è€ƒ...') {
                    setMarkdownContent(textDiv, 'æŠ±æ­‰ï¼Œæ²¡æœ‰æ”¶åˆ°å›å¤');
                }
                
                // ç§»é™¤åŠ è½½çŠ¶æ€
                inputWrapper.classList.remove('loading');
            },
            // onContext: å¤„ç†æ–‡æ¡£ä¸Šä¸‹æ–‡
            (documents) => {
                const showContext = document.getElementById('showContext').checked;
                if (showContext && documents && documents.length > 0) {
                    addContextToMessage(assistantDiv, documents);
                }
            }
        );
    } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        setMarkdownContent(textDiv, 'æŠ±æ­‰ï¼Œç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜');
        textDiv.style.color = 'var(--error-color)';
        utils.showMessage('å‘é€å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'), 'error');
        
        // ç§»é™¤åŠ è½½çŠ¶æ€
        inputWrapper.classList.remove('loading');
    }
});

// æ·»åŠ æ–‡æ¡£ä¸Šä¸‹æ–‡åˆ°æ¶ˆæ¯ï¼ˆç®€æ´ç‰ˆæœ¬ï¼Œå‚è€ƒæ—§ç‰ˆè®¾è®¡ï¼‰
function addContextToMessage(messageElement, documents) {
    if (!documents || documents.length === 0) return;
    
    // æŸ¥æ‰¾ä¸“é—¨çš„contextåŒºåŸŸ
    const messageContextArea = messageElement.querySelector('.message-context');
    if (!messageContextArea) {
        console.error('æ‰¾ä¸åˆ°.message-contextåŒºåŸŸï¼');
        return;
    }
    
    const contextDiv = document.createElement('div');
    contextDiv.className = 'context-section';
    
    // åˆ›å»ºå¯æŠ˜å çš„å¤´éƒ¨
    const headerDiv = document.createElement('div');
    headerDiv.className = 'context-header';
    headerDiv.style.cssText = `
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
        margin-bottom: 0.5rem;
    `;
    
    const titleDiv = document.createElement('div');
    titleDiv.style.cssText = `
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--primary-color, #007bff);
        font-size: 0.9em;
    `;
    
    const iconSpan = document.createElement('span');
    iconSpan.style.cssText = `margin-right: 0.5rem;`;
    iconSpan.textContent = 'ğŸ“š';
    
    const titleSpan = document.createElement('span');
    titleSpan.textContent = `æ£€ç´¢åˆ° ${documents.length} ä¸ªç›¸å…³æ–‡æ¡£ç‰‡æ®µ`;
    
    const toggleIcon = document.createElement('span');
    toggleIcon.style.cssText = `
        font-size: 0.8em;
        color: var(--text-secondary, #666);
        transition: transform 0.2s ease;
    `;
    toggleIcon.textContent = 'â–¼';
    
    titleDiv.appendChild(iconSpan);
    titleDiv.appendChild(titleSpan);
    headerDiv.appendChild(titleDiv);
    headerDiv.appendChild(toggleIcon);
    
    // åˆ›å»ºå¯æŠ˜å çš„å†…å®¹åŒºåŸŸ
    const contentDiv = document.createElement('div');
    contentDiv.className = 'context-content';
    contentDiv.style.cssText = `
        max-height: 200px;
        overflow-y: auto;
        transition: all 0.3s ease;
    `;
    
    documents.forEach((doc, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'context-item';
        itemDiv.style.cssText = `
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--background-secondary, #f8f9fa);
            border-radius: 0.25rem;
            border-left: 3px solid var(--primary-color, #007bff);
            font-size: 0.85em;
        `;
        
        const scoreSpan = document.createElement('span');
        scoreSpan.className = 'context-score';
        scoreSpan.style.cssText = `
            display: inline-block;
            background: var(--success-color, #28a745);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 0.75rem;
            font-size: 0.8em;
            margin-right: 0.5rem;
            font-weight: 500;
        `;
        scoreSpan.textContent = `${Math.round((doc.score || 0) * 100)}%`;
        
        // æ–‡ä»¶åï¼ˆå¦‚æœæœ‰ï¼‰
        const fileName = doc.metadata?.file_name || doc.metadata?.filename;
        if (fileName) {
            const fileSpan = document.createElement('span');
            fileSpan.style.cssText = `
                font-weight: 600;
                color: var(--text-primary, #333);
                margin-right: 0.5rem;
            `;
            fileSpan.textContent = `[${fileName}] `;
            itemDiv.appendChild(fileSpan);
        }
        
        const contentSpan = document.createElement('span');
        contentSpan.style.cssText = `
            color: var(--text-secondary, #666);
            line-height: 1.4;
        `;
        // é™åˆ¶æ˜¾ç¤ºé•¿åº¦
        const content = doc.content || '';
        contentSpan.textContent = content.length > 150 ? content.substring(0, 150) + '...' : content;
        
        itemDiv.appendChild(scoreSpan);
        itemDiv.appendChild(contentSpan);
        contentDiv.appendChild(itemDiv);
    });
    
    contextDiv.appendChild(headerDiv);
    contextDiv.appendChild(contentDiv);
    
    // æ·»åŠ æŠ˜å /å±•å¼€åŠŸèƒ½
    let isCollapsed = false;
    headerDiv.addEventListener('click', () => {
        if (isCollapsed) {
            contentDiv.style.maxHeight = '200px';
            contentDiv.style.opacity = '1';
            toggleIcon.style.transform = 'rotate(0deg)';
            toggleIcon.textContent = 'â–¼';
        } else {
            contentDiv.style.maxHeight = '0';
            contentDiv.style.opacity = '0';
            toggleIcon.style.transform = 'rotate(-90deg)';
            toggleIcon.textContent = 'â–¶';
        }
        isCollapsed = !isCollapsed;
    });
    
    messageContextArea.appendChild(contextDiv);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    const container = document.getElementById('messageContainer');
    container.scrollTop = container.scrollHeight;
}

// çŸ¥è¯†åº“é€‰æ‹©å˜åŒ–
document.getElementById('kbSelect').addEventListener('change', (e) => {
    currentKbId = e.target.value ? parseInt(e.target.value) : null;
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    
    // å§‹ç»ˆå¯ç”¨è¾“å…¥æ¡†ï¼Œå…è®¸ç”¨æˆ·ä¸é€‰æ‹©çŸ¥è¯†åº“ä¹Ÿèƒ½èŠå¤©
    input.disabled = false;
    sendBtn.disabled = false;
    
    if (currentKbId) {
        input.placeholder = 'è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆä½¿ç”¨çŸ¥è¯†åº“ï¼‰...';
    } else {
        input.placeholder = 'è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆä¸ä½¿ç”¨çŸ¥è¯†åº“ï¼‰...';
    }
});

// åˆå§‹åŒ–è¾“å…¥æ¡†çŠ¶æ€å’ŒåŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const charCount = document.getElementById('charCount');
    
    // å¯ç”¨è¾“å…¥æ¡†ï¼Œå…è®¸ç”¨æˆ·ç›´æ¥å¼€å§‹èŠå¤©
    messageInput.disabled = false;
    sendBtn.disabled = false;
    messageInput.placeholder = 'è¾“å…¥æ‚¨çš„é—®é¢˜...';
    
    // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
    function adjustTextareaHeight() {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    }
    
    // æ›´æ–°å­—ç¬¦è®¡æ•°
    function updateCharCount() {
        const count = messageInput.value.length;
        charCount.textContent = count;
        
        // æ ¹æ®å­—ç¬¦æ•°é‡æ”¹å˜é¢œè‰²
        if (count > 1800) {
            charCount.style.color = '#dc3545'; // çº¢è‰²è­¦å‘Š
        } else if (count > 1500) {
            charCount.style.color = '#fd7e14'; // æ©™è‰²æé†’
        } else {
            charCount.style.color = 'var(--text-secondary, #999)';
        }
        
        // è¶…è¿‡é™åˆ¶æ—¶ç¦ç”¨å‘é€æŒ‰é’®
        if (count > 2000) {
            sendBtn.disabled = true;
            sendBtn.title = 'æ¶ˆæ¯è¿‡é•¿ï¼Œè¯·ç¼©çŸ­åå†å‘é€';
        } else if (count === 0) {
            sendBtn.disabled = true;
            sendBtn.title = '';
        } else {
            sendBtn.disabled = false;
            sendBtn.title = '';
        }
    }
    
    // ç»‘å®šäº‹ä»¶
    messageInput.addEventListener('input', function() {
        adjustTextareaHeight();
        updateCharCount();
    });
    
    messageInput.addEventListener('keydown', function(e) {
        // Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) {
                document.getElementById('chatForm').dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // åˆå§‹åŒ–
    updateCharCount();
});
</script>
</body>
</html>
{{end}}